softmax和分类模型
内容包含：

softmax回归的基本概念
如何获取Fashion-MNIST数据集和读取数据
softmax回归模型的从零开始实现，实现一个对Fashion-MNIST训练集中的图像数据进行分类的模型
使用pytorch重新实现softmax回归模型
softmax的基本概念
分类问题
一个简单的图像分类问题，输入图像的高和宽均为2像素，色彩为灰度。
图像中的4像素分别记为 𝑥1,𝑥2,𝑥3,𝑥4 。
假设真实标签为狗、猫或者鸡，这些标签对应的离散值为 𝑦1,𝑦2,𝑦3 。
我们通常使用离散的数值来表示类别，例如 𝑦1=1,𝑦2=2,𝑦3=3 。

权重矢量
𝑜1=𝑥1𝑤11+𝑥2𝑤21+𝑥3𝑤31+𝑥4𝑤41+𝑏1
 
𝑜2=𝑥1𝑤12+𝑥2𝑤22+𝑥3𝑤32+𝑥4𝑤42+𝑏2
 
𝑜3=𝑥1𝑤13+𝑥2𝑤23+𝑥3𝑤33+𝑥4𝑤43+𝑏3
 
神经网络图
下图用神经网络图描绘了上面的计算。softmax回归同线性回归一样，也是一个单层神经网络。由于每个输出 𝑜1,𝑜2,𝑜3 的计算都要依赖于所有的输入 𝑥1,𝑥2,𝑥3,𝑥4 ，softmax回归的输出层也是一个全连接层。
Image Name

𝑠𝑜𝑓𝑡𝑚𝑎𝑥回归是一个单层神经网络
 
既然分类问题需要得到离散的预测输出，一个简单的办法是将输出值 𝑜𝑖 当作预测类别是 𝑖 的置信度，并将值最大的输出所对应的类作为预测输出，即输出  argmax𝑖𝑜𝑖 。例如，如果 𝑜1,𝑜2,𝑜3 分别为 0.1,10,0.1 ，由于 𝑜2 最大，那么预测类别为2，其代表猫。

输出问题
直接使用输出层的输出有两个问题：
一方面，由于输出层的输出值的范围不确定，我们难以直观上判断这些值的意义。例如，刚才举的例子中的输出值10表示“很置信”图像类别为猫，因为该输出值是其他两类的输出值的100倍。但如果 𝑜1=𝑜3=103 ，那么输出值10却又表示图像类别为猫的概率很低。
另一方面，由于真实标签是离散值，这些离散值与不确定范围的输出值之间的误差难以衡量。
softmax运算符（softmax operator）解决了以上两个问题。它通过下式将输出值变换成值为正且和为1的概率分布：

𝑦̂ 1,𝑦̂ 2,𝑦̂ 3=softmax(𝑜1,𝑜2,𝑜3)
 
其中

𝑦̂ 1=exp(𝑜1)∑3𝑖=1exp(𝑜𝑖),𝑦̂ 2=exp(𝑜2)∑3𝑖=1exp(𝑜𝑖),𝑦̂ 3=exp(𝑜3)∑3𝑖=1exp(𝑜𝑖).
 
容易看出 𝑦̂ 1+𝑦̂ 2+𝑦̂ 3=1 且 0≤𝑦̂ 1,𝑦̂ 2,𝑦̂ 3≤1 ，因此 𝑦̂ 1,𝑦̂ 2,𝑦̂ 3 是一个合法的概率分布。这时候，如果 𝑦̂ 2=0.8 ，不管 𝑦̂ 1 和 𝑦̂ 3 的值是多少，我们都知道图像类别为猫的概率是80%。此外，我们注意到

argmax𝑖𝑜𝑖=argmax𝑖𝑦̂ 𝑖
 
因此softmax运算不改变预测类别输出。

计算效率
单样本矢量计算表达式
为了提高计算效率，我们可以将单样本分类通过矢量计算来表达。在上面的图像分类问题中，假设softmax回归的权重和偏差参数分别为
𝑊=⎡⎣⎢⎢⎢⎢𝑤11𝑤21𝑤31𝑤41𝑤12𝑤22𝑤32𝑤42𝑤13𝑤23𝑤33𝑤43⎤⎦⎥⎥⎥⎥,𝑏=[𝑏1𝑏2𝑏3],
 
设高和宽分别为2个像素的图像样本 𝑖 的特征为

𝑥(𝑖)=[𝑥(𝑖)1𝑥(𝑖)2𝑥(𝑖)3𝑥(𝑖)4],
 
输出层的输出为

𝑜(𝑖)=[𝑜(𝑖)1𝑜(𝑖)2𝑜(𝑖)3],
 
预测为狗、猫或鸡的概率分布为

𝑦̂ (𝑖)=[𝑦̂ (𝑖)1𝑦̂ (𝑖)2𝑦̂ (𝑖)3].
 
softmax回归对样本 𝑖 分类的矢量计算表达式为

𝑜(𝑖)𝑦̂ (𝑖)=𝑥(𝑖)𝑊+𝑏,=softmax(𝑜(𝑖)).
 
小批量矢量计算表达式
为了进一步提升计算效率，我们通常对小批量数据做矢量计算。广义上讲，给定一个小批量样本，其批量大小为 𝑛 ，输入个数（特征数）为 𝑑 ，输出个数（类别数）为 𝑞 。设批量特征为 𝑋∈ℝ𝑛×𝑑 。假设softmax回归的权重和偏差参数分别为 𝑊∈ℝ𝑑×𝑞 和 𝑏∈ℝ1×𝑞 。softmax回归的矢量计算表达式为
𝑂𝑌̂ =𝑋𝑊+𝑏,=softmax(𝑂),
 
其中的加法运算使用了广播机制， 𝑂,𝑌̂ ∈ℝ𝑛×𝑞 且这两个矩阵的第 𝑖 行分别为样本 𝑖 的输出 𝑜(𝑖) 和概率分布 𝑦̂ (𝑖) 。

交叉熵损失函数
对于样本 𝑖 ，我们构造向量 𝑦(𝑖)∈ℝ𝑞  ，使其第 𝑦(𝑖) （样本 𝑖 类别的离散数值）个元素为1，其余为0。这样我们的训练目标可以设为使预测概率分布 𝑦̂ (𝑖) 尽可能接近真实的标签概率分布 𝑦(𝑖) 。

平方损失估计
𝐿𝑜𝑠𝑠=|𝑦̂ (𝑖)−𝑦(𝑖)|2/2
 
然而，想要预测分类结果正确，我们其实并不需要预测概率完全等于标签概率。例如，在图像分类的例子里，如果 𝑦(𝑖)=3 ，那么我们只需要 𝑦̂ (𝑖)3 比其他两个预测值 𝑦̂ (𝑖)1 和 𝑦̂ (𝑖)2 大就行了。即使 𝑦̂ (𝑖)3 值为0.6，不管其他两个预测值为多少，类别预测均正确。而平方损失则过于严格，例如 𝑦̂ (𝑖)1=𝑦̂ (𝑖)2=0.2 比 𝑦̂ (𝑖)1=0,𝑦̂ (𝑖)2=0.4 的损失要小很多，虽然两者都有同样正确的分类预测结果。

改善上述问题的一个方法是使用更适合衡量两个概率分布差异的测量函数。其中，交叉熵（cross entropy）是一个常用的衡量方法：

𝐻(𝑦(𝑖),𝑦̂ (𝑖))=−∑𝑗=1𝑞𝑦(𝑖)𝑗log𝑦̂ (𝑖)𝑗,
 
其中带下标的 𝑦(𝑖)𝑗 是向量 𝑦(𝑖) 中非0即1的元素，需要注意将它与样本 𝑖 类别的离散数值，即不带下标的 𝑦(𝑖) 区分。在上式中，我们知道向量 𝑦(𝑖) 中只有第 𝑦(𝑖) 个元素 𝑦(𝑖)𝑦(𝑖) 为1，其余全为0，于是 𝐻(𝑦(𝑖),𝑦̂ (𝑖))=−log𝑦̂ 𝑦(𝑖)(𝑖) 。也就是说，交叉熵只关心对正确类别的预测概率，因为只要其值足够大，就可以确保分类结果正确。当然，遇到一个样本有多个标签时，例如图像里含有不止一个物体时，我们并不能做这一步简化。但即便对于这种情况，交叉熵同样只关心对图像中出现的物体类别的预测概率。

假设训练数据集的样本数为 𝑛 ，交叉熵损失函数定义为
ℓ(𝚯)=1𝑛∑𝑖=1𝑛𝐻(𝑦(𝑖),𝑦̂ (𝑖)),
 
其中 𝚯 代表模型参数。同样地，如果每个样本只有一个标签，那么交叉熵损失可以简写成 ℓ(𝚯)=−(1/𝑛)∑𝑛𝑖=1log𝑦̂ (𝑖)𝑦(𝑖) 。从另一个角度来看，我们知道最小化 ℓ(𝚯) 等价于最大化 exp(−𝑛ℓ(𝚯))=∏𝑛𝑖=1𝑦̂ (𝑖)𝑦(𝑖) ，即最小化交叉熵损失函数等价于最大化训练数据集所有标签类别的联合预测概率。

模型训练和预测
在训练好softmax回归模型后，给定任一样本特征，就可以预测每个输出类别的概率。通常，我们把预测概率最大的类别作为输出类别。如果它与真实类别（标签）一致，说明这次预测是正确的。在3.6节的实验中，我们将使用准确率（accuracy）来评价模型的表现。它等于正确预测数量与总预测数量之比。
